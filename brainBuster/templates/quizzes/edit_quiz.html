<!-- edit_quiz.html -->

{% extends 'base.html' %}

{% block content %}
<div class="container py-5">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="fw-bold mb-3">Edit Quiz</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Edit Quiz</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body p-4">
                    <form id="quiz-form" method="post">
                        {% csrf_token %}
                        
                        <div class="mb-4">
                            <label for="quiz_title" class="form-label fw-medium">Quiz Title</label>
                            <input type="text" class="form-control" id="quiz_title" name="quiz_title" required value="{{ quiz.title }}">
                        </div>
                        
                        <div class="mb-4">
                            <label for="quiz_description" class="form-label fw-medium">Description (Optional)</label>
                            <textarea class="form-control" id="quiz_description" name="quiz_description" rows="3">{{ quiz.description }}</textarea>
                        </div>
                        
                        <div class="mb-4">
                            <label for="quiz_icon" class="form-label fw-medium">Icon</label>
                            <select class="form-select" id="quiz_icon" name="quiz_icon">
                                <option value="question-circle" {% if quiz.icon == 'question-circle' %}selected{% endif %}>Question Circle</option>
                                <option value="book" {% if quiz.icon == 'book' %}selected{% endif %}>Book</option>
                                <option value="code" {% if quiz.icon == 'code' %}selected{% endif %}>Code</option>
                                <option value="flask" {% if quiz.icon == 'flask' %}selected{% endif %}>Science Flask</option>
                                <option value="calculator" {% if quiz.icon == 'calculator' %}selected{% endif %}>Calculator</option>
                                <option value="palette" {% if quiz.icon == 'palette' %}selected{% endif %}>Art Palette</option>
                                <option value="music" {% if quiz.icon == 'music' %}selected{% endif %}>Music</option>
                                <option value="globe" {% if quiz.icon == 'globe' %}selected{% endif %}>Globe</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label for="time_limit_seconds" class="form-label fw-medium">Time Limit Per Question (seconds)</label>
                            <input type="number" class="form-control" id="time_limit_seconds" name="time_limit_seconds" min="5" max="300" value="{{ quiz.time_limit_per_question }}">
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label fw-medium">Questions</label>
                            <div id="questions-container">
                                <!-- Questions will be added dynamically here -->
                            </div>
                            
                            <button type="button" id="add-question" class="btn btn-outline-primary mt-3">
                                <i class="fas fa-plus me-2"></i> Add Question
                            </button>
                        </div>
                        
                        <input type="hidden" id="quiz_data" name="quiz_data" value="">
                        
                        <div class="d-flex justify-content-between mt-5">
                            <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">Cancel</a>
                            <button type="submit" id="save-quiz" class="btn btn-primary">Save Quiz</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        let questionTemplate = `
            <div class="question-card card mb-3">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Question <span class="question-number"></span></h5>
                    <button type="button" class="btn btn-sm btn-outline-danger remove-question">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Question Text</label>
                        <textarea class="form-control question-text" rows="2" required></textarea>
                    </div>
                    <div class="options-container">
                        <div class="option-row mb-2 d-flex align-items-center">
                            <div class="form-check me-2">
                                <input class="form-check-input option-correct" type="radio" name="correct-0">
                            </div>
                            <input type="text" class="form-control option-text" placeholder="Option text" required>
                            <button type="button" class="btn btn-sm btn-outline-danger ms-2 remove-option">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary mt-2 add-option">
                        <i class="fas fa-plus me-1"></i> Add Option
                    </button>
                </div>
            </div>
        `;

        const questionsContainer = document.getElementById('questions-container');
        const addQuestionBtn = document.getElementById('add-question');
        const saveQuizBtn = document.getElementById('save-quiz');
        const quizForm = document.getElementById('quiz-form');
        
        // Load existing quiz data
        const questionsData = {{ questions_data|safe }};
        
        // Function to add a new question
        function addQuestion(questionData = null) {
            const questionDiv = document.createElement('div');
            questionDiv.innerHTML = questionTemplate;
            questionsContainer.appendChild(questionDiv);
            
            const questionCard = questionDiv.querySelector('.question-card');
            const optionsContainer = questionCard.querySelector('.options-container');
            const addOptionBtn = questionCard.querySelector('.add-option');
            const removeQuestionBtn = questionCard.querySelector('.remove-question');
            
            // Update question numbers
            updateQuestionNumbers();
            
            // Add option button
            addOptionBtn.addEventListener('click', function() {
                addOption(optionsContainer, questionCard);
            });
            
            // Remove question button
            removeQuestionBtn.addEventListener('click', function() {
                questionCard.remove();
                updateQuestionNumbers();
            });
            
            // Set up the first option's radio button
            const firstOptionRadio = questionCard.querySelector('.option-correct');
            const questionIndex = document.querySelectorAll('.question-card').length - 1;
            firstOptionRadio.name = `correct-${questionIndex}`;
            
            // If we have data, fill in the question
            if (questionData) {
                questionCard.querySelector('.question-text').value = questionData.text;
                
                // Remove the default option row
                optionsContainer.innerHTML = '';
                
                // Add options with data
                questionData.options.forEach((optionText, index) => {
                    const optionRow = addOption(optionsContainer, questionCard);
                    optionRow.querySelector('.option-text').value = optionText;
                    
                    // Check if this is the correct answer
                    if (index === questionData.correctAnswer) {
                        optionRow.querySelector('.option-correct').checked = true;
                    }
                });
            }
            
            return questionCard;
        }
        
        // Function to add a new option
        function addOption(container, questionCard) {
            const questionIndex = Array.from(document.querySelectorAll('.question-card')).indexOf(questionCard);
            
            const optionRow = document.createElement('div');
            optionRow.className = 'option-row mb-2 d-flex align-items-center';
            optionRow.innerHTML = `
                <div class="form-check me-2">
                    <input class="form-check-input option-correct" type="radio" name="correct-${questionIndex}">
                </div>
                <input type="text" class="form-control option-text" placeholder="Option text" required>
                <button type="button" class="btn btn-sm btn-outline-danger ms-2 remove-option">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(optionRow);
            
            // Remove option button
            optionRow.querySelector('.remove-option').addEventListener('click', function() {
                optionRow.remove();
            });
            
            return optionRow;
        }
        
        // Function to update question numbers
        function updateQuestionNumbers() {
            document.querySelectorAll('.question-number').forEach((span, index) => {
                span.textContent = index + 1;
            });
            
            // Update radio button names
            document.querySelectorAll('.question-card').forEach((card, cardIndex) => {
                card.querySelectorAll('.option-correct').forEach(radio => {
                    radio.name = `correct-${cardIndex}`;
                });
            });
        }
        
        // Add question button
        addQuestionBtn.addEventListener('click', function() {
            addQuestion();
        });
        
        // Form submission
        quizForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const quizData = {
                questions: []
            };
            
            // Validate and collect data
            const questionCards = document.querySelectorAll('.question-card');
            
            if (questionCards.length === 0) {
                alert('Please add at least one question to your quiz.');
                return;
            }
            
            let isValid = true;
            
            questionCards.forEach((card, index) => {
                const questionText = card.querySelector('.question-text').value.trim();
                const optionRows = card.querySelectorAll('.option-row');
                const options = [];
                let correctAnswerIndex = -1;
                
                optionRows.forEach((row, optIndex) => {
                    const optionText = row.querySelector('.option-text').value.trim();
                    if (optionText === '') {
                        isValid = false;
                        alert(`Please fill in all option texts for question ${index + 1}.`);
                        return;
                    }
                    
                    options.push(optionText);
                    
                    if (row.querySelector('.option-correct').checked) {
                        correctAnswerIndex = optIndex;
                    }
                });
                
                if (questionText === '') {
                    isValid = false;
                    alert(`Please fill in the question text for question ${index + 1}.`);
                    return;
                }
                
                if (options.length < 2) {
                    isValid = false;
                    alert(`Please add at least two options for question ${index + 1}.`);
                    return;
                }
                
                if (correctAnswerIndex === -1) {
                    isValid = false;
                    alert(`Please select a correct answer for question ${index + 1}.`);
                    return;
                }
                
                quizData.questions.push({
                    text: questionText,
                    options: options,
                    correctAnswer: correctAnswerIndex
                });
            });
            
            if (!isValid) {
                return;
            }
            
            // Set quiz data to hidden field
            document.getElementById('quiz_data').value = JSON.stringify(quizData);
            
            // Submit form
            quizForm.submit();
        });
        
        // Load existing questions if available
        if (questionsData && questionsData.length > 0) {
            questionsData.forEach(question => {
                addQuestion(question);
            });
        } else {
            // Add one empty question to start
            addQuestion();
        }
    });
</script>
{% endblock %}